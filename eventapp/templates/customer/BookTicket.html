{% extends 'layout/base.html' %}

{% block title %}Đặt Vé - {{ event.title }} - EventHub{% endblock %}

{% block extra_css %}
<style>
.ticket-card {
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.ticket-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
}

.ticket-card.selected {
    border-color: #0d6efd;
    background-color: #f8f9ff;
}

.quantity-input {
    width: 120px;
}

.quantity-btn {
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.event-info-card {
    position: sticky;
    top: 100px;
}

.price-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.booking-form {
    background: #f8f9fa;
    border-radius: 15px;
}

@media (max-width: 768px) {
    .event-info-card {
        position: relative;
        top: auto;
        margin-bottom: 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('events') }}">Sự kiện</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('event_detail', event_id=event.id) }}">{{ event.title }}</a></li>
            <li class="breadcrumb-item active">Đặt vé</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Event Info Sidebar -->
        <div class="col-lg-4 col-md-5">
            <div class="card event-info-card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Thông Tin Sự Kiện</h5>
                </div>
                <div class="card-body">
                    <!-- Event Image -->
                    {% if event.poster_url %}
                        <img src="{{ event.poster_url }}" class="img-fluid rounded mb-3" alt="{{ event.title }}">
                    {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3" style="height: 200px;">
                            <i class="fas fa-image text-muted fa-3x"></i>
                        </div>
                    {% endif %}

                    <!-- Event Details -->
                    <h6 class="fw-bold mb-3">{{ event.title }}</h6>
                    
                    <div class="mb-2">
                        <i class="fas fa-calendar text-primary me-2"></i>
                        <small>{{ event.start_time.strftime('%d/%m/%Y %H:%M') }}</small>
                    </div>
                    
                    <div class="mb-2">
                        <i class="fas fa-map-marker-alt text-danger me-2"></i>
                        <small>{{ event.location }}</small>
                    </div>
                    
                    <div class="mb-2">
                        <i class="fas fa-tag text-success me-2"></i>
                        <small>{{ event.category.value.title() }}</small>
                    </div>

                    {% if event.description %}
                    <div class="mt-3">
                        <small class="text-muted">{{ event.description[:100] }}{% if event.description|length > 100 %}...{% endif %}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Booking Form -->
        <div class="col-lg-8 col-md-7">
            <div class="booking-form p-4">
                <h3 class="mb-4"><i class="fas fa-ticket-alt text-primary me-2"></i>Chọn Loại Vé</h3>

                <!-- Ticket Types -->
                <div class="row" id="ticketContainer">
                    {% for ticket_type in ticket_types %}
                    <div class="col-12 mb-3">
                        <div class="card ticket-card" data-ticket-id="{{ ticket_type.id }}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-5">
                                        <h6 class="mb-1 fw-bold">{{ ticket_type.name }}</h6>
                                        <p class="text-muted small mb-1">{{ ticket_type.description or 'Không có mô tả' }}</p>
                                        <div class="text-success fw-bold">{{ "{:,.0f}".format(ticket_type.price) }}đ</div>
                                        <small class="text-muted">Còn lại: {{ ticket_type.total_quantity - ticket_type.sold_quantity }} vé</small>
                                    </div>
                                    
                                    <div class="col-md-4 text-center">
                                        <label class="form-label small">Số lượng</label>
                                        <div class="input-group quantity-input mx-auto">
                                            <button class="btn btn-outline-secondary quantity-btn" type="button" 
                                                    onclick="decreaseQuantity({{ ticket_type.id }})">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" class="form-control text-center" 
                                                   id="quantity_{{ ticket_type.id }}" 
                                                   value="0" min="0" max="{{ ticket_type.total_quantity - ticket_type.sold_quantity }}"
                                                   onchange="updateQuantity({{ ticket_type.id }}, this.value)">
                                            <button class="btn btn-outline-secondary quantity-btn" type="button" 
                                                    onclick="increaseQuantity({{ ticket_type.id }})">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 text-end">
                                        <div class="fw-bold text-primary" id="total_{{ ticket_type.id }}">0đ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Payment Method -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Phương Thức Thanh Toán</label>
                        <select class="form-select" id="paymentMethod" onchange="calculateTotal()">
                            {% for method in payment_methods %}
                            <option value="{{ method.value }}">{{ method.value.replace('_', ' ').title() }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Discount Code -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Mã Giảm Giá</label>
                        <select class="form-select" id="discountCode" onchange="calculateTotal()">
                            <option value="">Không sử dụng mã giảm giá</option>
                            {% for discount in discount_codes %}
                            <option value="{{ discount.code }}" 
                                    data-percentage="{{ discount.discount_percentage }}"
                                    data-valid-from="{{ discount.valid_from.strftime('%d/%m/%Y') }}"
                                    data-valid-to="{{ discount.valid_to.strftime('%d/%m/%Y') }}">
                                {{ discount.code }} - {{ discount.discount_percentage }}% 
                                ({{ discount.valid_from.strftime('%d/%m') }} - {{ discount.valid_to.strftime('%d/%m') }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Price Summary -->
                <div class="card mt-4 price-summary">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="fas fa-calculator me-2"></i>Tóm Tắt Đơn Hàng</h5>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tạm tính:</span>
                            <span id="subtotal">0đ</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2" id="discountRow" style="display: none;">
                            <span>Giảm giá <span id="discountInfo"></span>:</span>
                            <span class="text-warning" id="discountAmount">0đ</span>
                        </div>
                        
                        <hr class="border-light">
                        
                        <div class="d-flex justify-content-between mb-3">
                            <h6 class="mb-0">Tổng tiền:</h6>
                            <h6 class="mb-0" id="totalAmount">0đ</h6>
                        </div>

                        <button class="btn btn-light btn-lg w-100" id="paymentBtn" disabled onclick="processPayment()">
                            <i class="fas fa-credit-card me-2"></i>Thanh Toán
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dữ liệu ticket types
const ticketTypes = {
    {% for ticket_type in ticket_types %}
    {{ ticket_type.id }}: {
        name: "{{ ticket_type.name }}",
        price: {{ ticket_type.price }},
        maxQuantity: {{ ticket_type.total_quantity - ticket_type.sold_quantity }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

let selectedTickets = {};

function increaseQuantity(ticketId) {
    const input = document.getElementById(`quantity_${ticketId}`);
    const currentValue = parseInt(input.value);
    const maxValue = parseInt(input.max);
    
    if (currentValue < maxValue) {
        input.value = currentValue + 1;
        updateQuantity(ticketId, input.value);
    }
}

function decreaseQuantity(ticketId) {
    const input = document.getElementById(`quantity_${ticketId}`);
    const currentValue = parseInt(input.value);
    
    if (currentValue > 0) {
        input.value = currentValue - 1;
        updateQuantity(ticketId, input.value);
    }
}

function updateQuantity(ticketId, quantity) {
    quantity = parseInt(quantity) || 0;
    const maxQuantity = ticketTypes[ticketId].maxQuantity;
    
    // Validate quantity
    if (quantity < 0) quantity = 0;
    if (quantity > maxQuantity) quantity = maxQuantity;
    
    // Update input value
    document.getElementById(`quantity_${ticketId}`).value = quantity;
    
    // Update selected tickets
    if (quantity > 0) {
        selectedTickets[ticketId] = {
            quantity: quantity,
            price: ticketTypes[ticketId].price,
            name: ticketTypes[ticketId].name
        };
    } else {
        delete selectedTickets[ticketId];
    }
    
    // Update total for this ticket type
    const total = quantity * ticketTypes[ticketId].price;
    document.getElementById(`total_${ticketId}`).textContent = formatCurrency(total);
    
    // Update ticket card appearance
    const card = document.querySelector(`[data-ticket-id="${ticketId}"]`);
    if (quantity > 0) {
        card.classList.add('selected');
    } else {
        card.classList.remove('selected');
    }
    
    // Recalculate total
    calculateTotal();
}

function calculateTotal() {
    let subtotal = 0;
    
    // Calculate subtotal
    Object.values(selectedTickets).forEach(ticket => {
        subtotal += ticket.quantity * ticket.price;
    });
    
    // Get discount
    const discountSelect = document.getElementById('discountCode');
    const selectedOption = discountSelect.selectedOptions[0];
    let discountPercentage = 0;
    let discountAmount = 0;
    
    if (selectedOption && selectedOption.value) {
        discountPercentage = parseFloat(selectedOption.dataset.percentage) || 0;
        discountAmount = (subtotal * discountPercentage) / 100;
    }
    
    const totalAmount = subtotal - discountAmount;
    
    // Update UI
    document.getElementById('subtotal').textContent = formatCurrency(subtotal);
    
    const discountRow = document.getElementById('discountRow');
    if (discountAmount > 0) {
        discountRow.style.display = 'flex';
        document.getElementById('discountInfo').textContent = `(${discountPercentage}%)`;
        document.getElementById('discountAmount').textContent = `-${formatCurrency(discountAmount)}`;
    } else {
        discountRow.style.display = 'none';
    }
    
    document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
    
    // Enable/disable payment button
    const paymentBtn = document.getElementById('paymentBtn');
    const hasTickets = Object.keys(selectedTickets).length > 0;
    paymentBtn.disabled = !hasTickets;
    
    if (hasTickets) {
        paymentBtn.classList.remove('btn-secondary');
        paymentBtn.classList.add('btn-success');
    } else {
        paymentBtn.classList.remove('btn-success');
        paymentBtn.classList.add('btn-secondary');
    }
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN').format(amount) + 'đ';
}

function processPayment() {
    if (Object.keys(selectedTickets).length === 0) {
        alert('Vui lòng chọn ít nhất một loại vé!');
        return;
    }
    
    // Prepare booking data
    const bookingData = {
        event_id: {{ event.id }},
        tickets: Object.keys(selectedTickets).map(ticketId => ({
            ticket_type_id: parseInt(ticketId),
            quantity: selectedTickets[ticketId].quantity,
            price: selectedTickets[ticketId].price,
            name: selectedTickets[ticketId].name
        })),
        payment_method: document.getElementById('paymentMethod').value,
        discount_code: document.getElementById('discountCode').value || null,
        subtotal: calculateSubtotal(),
        discount_amount: calculateDiscountAmount(),
        total_amount: calculateFinalTotal()
    };
    
    // Show loading
    const paymentBtn = document.getElementById('paymentBtn');
    const originalText = paymentBtn.innerHTML;
    paymentBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
    paymentBtn.disabled = true;
    
    // Send to backend
    fetch('{{ url_for("process_booking") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Đặt vé thành công! (Demo mode)');
            // In production: redirect to payment gateway or confirmation page
            console.log('Booking data:', bookingData);
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Đã xảy ra lỗi khi xử lý đặt vé.');
    })
    .finally(() => {
        paymentBtn.innerHTML = originalText;
        paymentBtn.disabled = false;
    });
}

function calculateSubtotal() {
    let subtotal = 0;
    Object.values(selectedTickets).forEach(ticket => {
        subtotal += ticket.quantity * ticket.price;
    });
    return subtotal;
}

function calculateDiscountAmount() {
    const discountSelect = document.getElementById('discountCode');
    const selectedOption = discountSelect.selectedOptions[0];
    
    if (selectedOption && selectedOption.value) {
        const discountPercentage = parseFloat(selectedOption.dataset.percentage) || 0;
        return (calculateSubtotal() * discountPercentage) / 100;
    }
    return 0;
}

function calculateFinalTotal() {
    return calculateSubtotal() - calculateDiscountAmount();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    calculateTotal();
});
</script>
{% endblock %}