{% extends 'layout/base.html' %}
{% block title %}Tạo Sự Kiện - EventHub{% endblock %}
{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  .stepper { display: flex; justify-content: space-between; margin-bottom: 1rem; }
  .step { padding: 0.5rem 1rem; background: #e5e7eb; border-radius: 0.25rem; }
  .step.active { background: #3b82f6; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Tạo Sự Kiện Mới</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4">
        {% for category, message in messages %}
          <div class="bg-{{ 'green' if category == 'success' else 'red' }}-100 text-{{ 'green' if category == 'success' else 'red' }}-800 p-2 rounded">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="stepper">
    <div class="step active" id="step1">Thông tin cơ bản</div>
    <div class="step" id="step2">Thông tin vé</div>
  </div>

  <form id="create-event-form" method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    <div id="basic-info" class="grid grid-cols-2 gap-4">
      <div>
        <label class="block">Tên sự kiện</label>
        {{ form.title(class="form-control w-full") }}
        {% for error in form.title.errors %}<p class="text-red-500">{{ error }}</p>{% endfor %}
      </div>
      <div>
        <label class="block">Danh mục</label>
        {{ form.category(class="form-control w-full") }}
        {% for error in form.category.errors %}<p class="text-red-500">{{ error }}</p>{% endfor %}
      </div>
      <div class="col-span-2">
        <label class="block">Mô tả</label>
        {{ form.description(class="form-control w-full") }}
        {% for error in form.description.errors %}<p class="text-red-500">{{ error }}</p>{% endfor %}
      </div>
      <div>
        <label class="block">Địa điểm</label>
        {{ form.location(class="form-control w-full") }}
        {% for error in form.location.errors %}<p class="text-red-500">{{ error }}</p>{% endfor %}
      </div>
      <div>
        <label class="block">Ngày bắt đầu</label>
        {{ form.start_time(class="form-control w-full") }}
        {% for error in form.start_time.errors %}<p class="text-red-500">{{ error }}</p>{% endfor %}
      </div>
      <div>
        <label class="block">Ngày kết thúc</label>
        {{ form.end_time(class="form-control w-full") }}
        {% for error in form.end_time.errors %}<p class="text-red-500">{{ error }}</p>{% endfor %}
      </div>
      <div>
        <label class="block">Tải hình ảnh</label>
        {{ form.poster(class="form-control-file") }}
        <img id="poster-preview" class="mt-2 max-w-xs hidden" />
        {% for error in form.poster.errors %}<p class="text-red-500">{{ error }}</p>{% endfor %}
      </div>
    </div>
    <div id="ticket-info" class="hidden grid grid-cols-2 gap-4">
      <div class="col-span-2">
        <label class="block">Loại vé</label>
        <div id="ticket-types-container">
          <div class="ticket-type flex space-x-2 mb-2">
            {{ form.ticket_name(class="form-control flex-1", placeholder="Tên vé") }}
            {{ form.price(class="form-control w-32", placeholder="Giá") }}
            {{ form.ticket_quantity(class="form-control w-32", placeholder="Số lượng") }}
            <button type="button" onclick="removeTicketType(this)" class="bg-red-500 text-white px-2 py-1 rounded">Xóa</button>
          </div>
        </div>
        <button type="button" onclick="addTicketType()" class="bg-green-500 text-white px-2 py-1 rounded mt-2">Thêm loại vé</button>
      </div>
    </div>
    <div class="mt-4 flex justify-between">
      <button type="button" id="prev-step" class="bg-gray-300 text-black px-4 py-2 rounded hidden">Quay lại</button>
      <button type="button" id="next-step" class="bg-blue-500 text-white px-4 py-2 rounded">Tiếp theo</button>
      <button type="submit" id="submit-btn" class="bg-blue-500 text-white px-4 py-2 rounded hidden">Tạo Sự Kiện</button>
      <a href="{{ url_for('organizer_my_events') }}" class="bg-gray-300 text-black px-4 py-2 rounded">Hủy</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function addTicketType(name = '', price = '', quantity = '') {
    const container = document.getElementById('ticket-types-container');
    const div = document.createElement('div');
    div.className = 'ticket-type flex space-x-2 mb-2';
    div.innerHTML = `
      <input type="text" name="ticket_names[]" placeholder="Tên vé" value="${name}" class="form-control flex-1" required>
      <input type="number" name="ticket_prices[]" placeholder="Giá" value="${price}" class="form-control w-32" required min="0">
      <input type="number" name="ticket_quantities[]" placeholder="Số lượng" value="${quantity}" class="form-control w-32" required min="1">
      <button type="button" onclick="removeTicketType(this)" class="bg-red-500 text-white px-2 py-1 rounded">Xóa</button>
    `;
    container.appendChild(div);
  }

  function removeTicketType(btn) {
    if (document.querySelectorAll('.ticket-type').length > 1) {
      btn.parentElement.remove();
    }
  }

  document.getElementById('next-step').addEventListener('click', () => {
    document.getElementById('basic-info').classList.add('hidden');
    document.getElementById('ticket-info').classList.remove('hidden');
    document.getElementById('step1').classList.remove('active');
    document.getElementById('step2').classList.add('active');
    document.getElementById('prev-step').classList.remove('hidden');
    document.getElementById('next-step').classList.add('hidden');
    document.getElementById('submit-btn').classList.remove('hidden');
  });

  document.getElementById('prev-step').addEventListener('click', () => {
    document.getElementById('basic-info').classList.remove('hidden');
    document.getElementById('ticket-info').classList.add('hidden');
    document.getElementById('step1').classList.add('active');
    document.getElementById('step2').classList.remove('active');
    document.getElementById('prev-step').classList.add('hidden');
    document.getElementById('next-step').classList.remove('hidden');
    document.getElementById('submit-btn').classList.add('hidden');
  });

  document.getElementById('poster').addEventListener('change', function(e) {
    const preview = document.getElementById('poster-preview');
    const file = e.target.files[0];
    if (file) {
      preview.src = URL.createObjectURL(file);
      preview.classList.remove('hidden');
    }
  });
</script>
{% endblock %}