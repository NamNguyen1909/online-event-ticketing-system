<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Nhân Viên - EventHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    {% extends 'layout/base.html' %}
    {% block title %}Quản Lý Nhân Viên - EventHub{% endblock %}
    {% block content %}
    <div class="container">
        <h1>Quản Lý Nhân Viên</h1>
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link {% if not request.args.get('event_id') and not request.args.get('search') %}active{% endif %}" id="staff-tab" data-bs-toggle="tab" href="#staff">Cấp Nhân Viên</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.args.get('event_id') %}active{% endif %}" id="assign-tab" data-bs-toggle="tab" href="#assign">Gán Nhân Viên Cho Sự Kiện</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade {% if not request.args.get('event_id')  and not request.args.get('search') %}show active{% endif %}" id="staff">
                <form method="get">
                    <div class="mb-3">
                        <label class="form-label">Tìm kiếm nhân viên</label>
                        <div class="input-group">
                            <input type="text" name="search" class="form-control" value="{{ search_term }}" placeholder="Nhập tên nhân viên">
                            <button type="submit" class="btn btn-primary">Tìm</button>
                        </div>
                    </div>
                </form>
                <h4>Nhân viên hiện tại</h4>
                {% if staff and staff|length > 0 %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên Người Dùng</th>
                            <th>Email</th>
                            <th>Vai trò</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in staff %}
                        <tr>
                            <td>{{ s.id }}</td>
                            <td>{{ s.username }}</td>
                            <td>{{ s.email }}</td>
                            <td>{{ s.role.value }}</td>
                            <td>
                                {% if s.role == UserRole.staff %}
                                <button class="btn btn-sm btn-warning update-role" data-user-id="{{ s.id }}" data-new-role="customer">Hạ cấp</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>Không tìm thấy nhân viên nào. Hãy nâng cấp người dùng lên nhân viên.</p>
                {% endif %}
                <hr>
                <h4>Nâng cấp người dùng lên nhân viên</h4>
                {% if customers and customers|length > 0 %}
                <ul>
                    {% for customer in customers %}
                    <li>
                        {{ customer.username }} ({{ customer.email }})
                        <button class="btn btn-sm btn-success update-role" data-user-id="{{ customer.id }}" data-new-role="staff">Nâng cấp</button>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>Không có người dùng nào để nâng cấp.</p>
                {% endif %}
                <a href="{{ url_for('organizer_my_events') }}" class="btn btn-secondary">Thoát</a>
            </div>
            <div class="tab-pane fade {% if request.args.get('event_id') %}show active{% endif %}" id="assign">
                <form method="get">
                    <div class="mb-3">
                        <label class="form-label">Chọn Sự Kiện</label>
                        <select name="event_id" class="form-control" required onchange="this.form.submit()">
                            <option value="">Chọn sự kiện</option>
                            {% for event in current_user.organized_events %}
<option value="{{ event.id }}" {% if event and event.id == request.args.get('event_id') %}selected{% endif %}>{{ event.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
                {% if event %}
                <h3>Nhân viên hiện tại của sự kiện "{{ event.title }}"</h3>
                <ul id="current-staff-list">
                </ul>
                <hr>
                <h5>Gán/Gỡ nhân viên</h5>
                <select id="staff-select" class="form-control">
                    <option value="">Chọn nhân viên</option>
                    {% for s in staff %}
                    <option value="{{ s.id }}">{{ s.username }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-primary" id="assign-staff-btn">Gán</button>
                <button class="btn btn-danger" id="remove-staff-btn">Gỡ</button>
                {% else %}
                <p>Vui lòng chọn sự kiện để gán nhân viên.</p>
                {% endif %}
                <a href="{{ url_for('organizer_my_events') }}" class="btn btn-secondary">Thoát</a>
            </div>
        </div>
    </div>
    {% endblock %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Update staff role
            document.querySelectorAll('.update-role').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.dataset.userId;
                    const newRole = this.dataset.newRole;
                    fetch(`/organizer/update-staff-role/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ role: newRole })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert(data.message);
                        }
                    });
                });
            });

            // Load current staff for event
            const eventId = new URLSearchParams(window.location.search).get('event_id');
            if (eventId) {
                fetch(`/organizer/event/${eventId}/staff`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const staffList = document.getElementById('current-staff-list');
                            staffList.innerHTML = '';
                            data.staff.forEach(s => {
                                const li = document.createElement('li');
                                li.textContent = `${s.username} (${s.email})`;
                                staffList.appendChild(li);
                            });
                        } else {
                            console.error('Failed to load staff:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading staff:', error);
                        const staffList = document.getElementById('current-staff-list');
                        staffList.innerHTML = '<li>Không thể tải danh sách nhân viên</li>';
                    });
            }

            // Assign staff to event
            const assignBtn = document.getElementById('assign-staff-btn');
            const removeBtn = document.getElementById('remove-staff-btn');
            
            if (assignBtn) {
                assignBtn.addEventListener('click', function() {
                    const eventId = new URLSearchParams(window.location.search).get('event_id');
                    if (!eventId) {
                        alert('Vui lòng chọn sự kiện trước');
                        return;
                    }
                    const staffId = document.getElementById('staff-select').value;
                    if (!staffId) {
                        alert('Vui lòng chọn nhân viên');
                        return;
                    }
                    fetch(`/organizer/assign-staff/${eventId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ staff_id: staffId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Đã xảy ra lỗi khi gán nhân viên');
                    });
                });
            }

            // Remove staff from event
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    const eventId = new URLSearchParams(window.location.search).get('event_id');
                    if (!eventId) {
                        alert('Vui lòng chọn sự kiện trước');
                        return;
                    }
                    const staffId = document.getElementById('staff-select').value;
                    if (!staffId) {
                        alert('Vui lòng chọn nhân viên');
                        return;
                    }
                    fetch(`/organizer/remove-staff/${eventId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ staff_id: staffId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Đã xảy ra lỗi khi gỡ nhân viên');
                    });
                });
            }
        });
    </script>
</body>
</html>